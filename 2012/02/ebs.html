<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="author" content="ayakomuro" />
    <meta name="robots" content="index, follow"/>

    <meta property="og:title" content="EBSのスナップショットについて"/>
    <meta property="og:url" content="http://blog.popowa.com/2012/02/ebs.html"/>
    <meta property="og:site_name" content="popowa"/>
    <meta property="og:type" content="article"/>

    <link rel="canonical" href="http://blog.popowa.com/2012/02/ebs.html" />

    <title>EBSのスナップショットについて | popowa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" />
    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" />

    <link rel="stylesheet" type="text/css" href="http://blog.popowa.com/theme/css/main.css" />

    <script type="text/javascript">var switchTo5x=true;</script>
    <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
    <script type="text/javascript">
        stLight.options({
            publisher: "",
            doNotHash: false,
            doNotCopy: false,
            hashAddressBar: false
        });
    </script>
</head>

<body id="index">
    <div class="row-fluid">
        <div class="span10 offset1">
            <header id="banner" >
                <h1>
                    <a href="http://blog.popowa.com/">popowa </a>
                </h1>
                <nav class="navbar">
                    <div class="navbar-inner">
                        <ul class="nav">
                            <li class="active"><a href="http://blog.popowa.com/category/misc.html">misc</a></li>
                            <li ><a href="http://blog.popowa.com/category/tech.html">tech</a></li>
                        </ul>

                    </div>
                </nav>
            </header><!-- /#banner -->
        </div>
    </div>

    <div class="row-fluid">
        <div class="span10 offset1">
            <div class="row-fluid">
<div class="span10 offset1">
  <section>
    <article>
      <header>
        <h1 class="entry-title">
          <a href="http://blog.popowa.com/2012/02/ebs.html" rel="bookmark"
             title="Permalink to EBSのスナップショットについて">EBSのスナップショットについて</a></h1>
      </header>
      <div class="entry-content">
<footer class="post-info">
    <address class="vcard author">
        by <a class="url fn" href="http://blog.popowa.com/author/ayakomuro.html">ayakomuro</a>
    </address>

    in <a href="http://blog.popowa.com/category/misc.html">misc</a>

    on 2012-02-12

        |
        tags:         <a href="http://blog.popowa.com/tag/amazon.html">Amazon</a>
        <a href="http://blog.popowa.com/tag/ebs.html">EBS</a>



    
</footer><!-- /.post-info -->

        <p>先日の #jawsug 福岡の会で、  </p>
<p><a href="https://twitter.com/#%21/kaz_goto/status/167571575296634881">https://twitter.com/#!/kaz_goto/status/167571575296634881</a></p>
<p><a href="http://2.bp.blogspot.com/-69900MMDsjE/TzXgL2bibrI/AAAAAAAAPMU/7bRhxxUO8UE/s1600/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%EF%BC%882012-02-11+12.27.14%EF%BC%89.png"><img alt="" src="http://2.bp.blogspot.com/-69900MMDsjE/TzXgL2bibrI/AAAAAAAAPMU/7bRhxxUO8UE/s1600/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%EF%BC%882012-02-11+12.27.14%EF%BC%89.png"></a></p>
<p>へーほーふー、知らなかったわーと思ってEBSのスナップショットだけにフォーカスして見ました。</p>
<p>記事</p>
<ul>
<li><a href="http://aws.amazon.com/jp/ebs/">Amazon Elastic Block Store (EBS)->日本語 by
    AWS</a></li>
<li><a href="http://aws.amazon.com/articles/1667">Feature Guide: Elastic Block Store ->英語 by
    AWS</a></li>
<li><a href="http://blog.rightscale.com/2008/08/20/amazon-ebs-explained/">Amazon's Elastic Block Store explained ->英語 by
    RightScale</a></li>
<li><a href="http://support.rightscale.com/12-Guides/Dashboard_Users_Guide/Clouds/AWS_Region/EBS_Volumes/Concepts/About_EBS_Volumes">About Elastic Block Store (EBS) ->英語 by
    RightScale</a></li>
</ul>
<p>今更感なEBSの機能おさらい☆</p>
<ul>
<li>外付け出来るブロックストレージ</li>
<li>1Gから1Tまでのストレージ領域を作成出来る</li>
<li>同じアベーラビリティゾーン内のインスタンスにマウント出来る</li>
<li>マウントしたインスタンスが落ちたら（障害なども含む）、勝手にアンマウントされる（はず）</li>
<li>好きなファイルフォーマット形式でフォーマットが出来る</li>
<li>作成したアベーラビリティゾーン内であれば、別のインスタンスにマウント出来る（EBSとインスタンスは絶対的な関係性が永続的にある訳ではない）</li>
<li>1EBSは1インスタンスにしかマウント出来ないが、1インスタンスは複数のEBSをマウント出来る</li>
<li>スナップショットをS3に取れる　\&lt;== 気になる点！</li>
</ul>
<p>EBSのスナップショットがS3に入るというのはどういう事なのでしょうか？</p>
<blockquote>
<p>Amazon EBS
スナップショットは、最後にスナップショットを撮った時点から変更のあるブロックのみを保存する差分バックアップです。</p>
</blockquote>
<p>ん？Git的な感じなのかしら？と思って@kaz_gotoさんが教えてくれたリンク、また検索などをして調べました。</p>
<p>簡単ですけど、こういう事らしいです。</p>
<p>☆初めてのわくわくドキドキのスナップショット ☆</p>
<ol>
<li>EBSを10Gで作ったとします。</li>
<li>色々置いて4Gになりました☆(・ω\&lt;)</li>
<li>初めてのスナップショットでは、EBSでの使用分はブロックに分けられて、S3に全部コピー＆保存されます。</li>
<li>保存されたブロックを管理するスナップショット管理表（=
    私たちが見るsnap-xxx）もS3に保存されます。</li>
</ol>
<p><a href="http://1.bp.blogspot.com/-pXJCCaRHz8o/TzYOnIt3SOI/AAAAAAAAPM0/9sGhGGqK2-I/s1600/ebs_first_backup.png"><img alt="" src="http://1.bp.blogspot.com/-pXJCCaRHz8o/TzYOnIt3SOI/AAAAAAAAPM0/9sGhGGqK2-I/s1600/ebs_first_backup.png"></a></p>
<p>☆2回目のスナップショット ☆</p>
<ol>
<li>前回から、4G中1Gを変更して、さらに新しく1G追加しました。</li>
<li>２回目のスナップショットでは、変更があった1G分のコピーを
    S3に取り、さらに新しく追加された1GもS3にコピーをとります。</li>
<li>そして<strong>スナップショット管理表2</strong>を作成し、前回S3に保存したブロック先３つ（以下の絵だと黄、緑、ピンク）と、変更、新規追加で作成したブロック先を一覧にしてS3に保存します。</li>
</ol>
<p><a href="http://4.bp.blogspot.com/-yFjr6cHvHeI/TzYOeigc3MI/AAAAAAAAPMc/58YdqDH_lAU/s1600/ebs_second_backup.png"><img alt="" src="http://4.bp.blogspot.com/-yFjr6cHvHeI/TzYOeigc3MI/AAAAAAAAPMc/58YdqDH_lAU/s640/ebs_second_backup.png">{width="640"
height="506"}</a></p>
<p>☆3回目のスナップショット ☆</p>
<ol>
<li>前回(2回目)から、5G中1G削除しました。</li>
<li>最初に配置した緑、ピンク、２回目に配置した青、紫を一覧にした<strong>スナップショット管理表3</strong>を作成しS3に保存します。</li>
</ol>
<p><a href="http://3.bp.blogspot.com/-AFpvbcqjSvA/TzYOfwo-rBI/AAAAAAAAPMk/kYrkdJktXw8/s1600/ebs_third_backup.png"><img alt="" src="http://3.bp.blogspot.com/-AFpvbcqjSvA/TzYOfwo-rBI/AAAAAAAAPMk/kYrkdJktXw8/s640/ebs_third_backup.png">{width="640"
height="340"}</a></p>
<p>特記すべき点</p>
<ul>
<li>私たちがAPIで見ているスナップショット(例えば<strong>snap-xxxxx</strong>)は、実際にS3に配置されているバックアップされたデータブロックへのポインタ一覧である</li>
<li>S3に取られたスナップショット単体を見る事が出来ない。S3のAPIではアクセスが不可能。EC2のAPI越しにスナップショットの詳細や、ボリューム作成を行う必要がある </li>
<li>最初のスナップショットを消しても、保存したブロックを必要としている別のスナップショットがあれば削除されない。</li>
<li>上記の逆を返すとどのスナップショットにも必要とされていないブロックは、紐付けようがないので削除される</li>
<li>~~1インスタンスにマウント出来るEBSは20まで。（AWSに依頼すれば解除してくれる）~~</li>
<li>~~[
    ]~~[1インスタンスに何個でもマウント出来る！\&lt;-
    new]</li>
<li>[Windowsインスタンスは12個上限でEBSをマウント出来る。\&lt;-
    new]</li>
<li>1インスタンスに10個以上のEBSをマウントするのはよくない by RightScale</li>
<li>1AWSアカウントで作れるスナップショットは、500まで（AWSに依頼すれば解除してくれる）</li>
<li>EBS側を削除しても、それに紐づくスナップショットが勝手に消えてくれる訳ではないらしい</li>
<li>1ブロックの詳細は公表されていないらしく、n回目のスナップショットでどれだけS3のスペースを使うか分からないそう。逆にどれだけスナップショットを削除したら節約出来るかが明確に分からないらしい</li>
<li>S3に保存されるデータは圧縮されている</li>
<li>EBSのスナップショットを作成している時はEBSのバックグラウンドで稼働し、マウントしているインスタンスには影響がない</li>
</ul>
<p>データーベースをEBS上で稼働させている場合</p>
<ul>
<li>EBSのスナップショットは非同期で行われるため、スナップショットが取られた瞬間に書き込みが発生すると誤差が生じる場合がある</li>
<li>RightScaleお勧めの方法としては、DBやファイルシステムを止める->スナップショット->再開、という方法がよいらしい</li>
</ul>
<p>RightScaleのお勧めファイルフォーマット形式はxfs<br>
xfsには、I/O処理を停止する機能が付いているのでそれを使うと楽との事。<br>
XFS単体での停止方法の例：  </p>
<blockquote>
<p>xfs_freeze -f \&lt;mount-point>
#実行中の処理が終わった後は新規書き込みは行われない<br>
ec2-create-snapshot \&lt;volume><br>
xfs_freeze -u \&lt;mount-point>  #再開する</p>
</blockquote>
<p>LVMとかを使用していたら:  </p>
<blockquote>
<p>dmsetup suspend \&lt;device><br>
ec2-create-snapshot \&lt;volume><br>
dmsetup resume \&lt;device></p>
</blockquote>
<p>なるほどー<br>
I/Oが高いデータベースとかをEBSに置いてスナップショットを取っている場合は、きちんと取れるように気をつけないとですね。</p>
<p>そう考えるとRDSのスナップショットも気になりますよね。どうなっているのかしら。<br>
想像だけどRDSは多分内部EC2 on
EBS上に構築されているのではないかしら、と思っているので、RDSのスナップショットもやはりS3?<br>
気になる木。</p>
<p>という訳でEBSのスナップショットについてでしたー！</p>
<p>これ違うよーというのがあればご指摘くださいm(_ _)m</p>
<p>追記2012/2/13:<br>
EBSのマウント数は、Windowsだと12個まで、それ以外では無制限だそうです！<br>
（赤で追記）<br>
<a href="http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/ebs-attaching-volume.html">http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/ebs-attaching-volume.html</a></p>

      </div><!-- /.entry-content -->

    </article>
  </section>
</div>
            </div>
        </div>
    </div>

    <footer id="site-footer">
        <div class="row-fluid">
            <div class="span10 offset1">
                <address>
                    <p>
                        This blog is proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                    </p>
                    <p>
                        <a href="http://github.com/jsliang/pelican-fresh/">Fresh</a> is a responsive theme designed by <a href="http://jsliang.com/">jsliang</a> and <a href="https://github.com/jsliang/pelican-fresh/graphs/contributors">contributors</a>.
                        Special thanks to <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a> and <a href="http://getbootstrap.com/">Twitter Bootstrap</a>.
                    </p>
                </address>
            </div>
        </div>
    </footer>

    <script src="//code.jquery.com/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>
</body>
</html>
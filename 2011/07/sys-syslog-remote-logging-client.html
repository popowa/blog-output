<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="author" content="ayakomuro" />
    <meta name="robots" content="index, follow"/>

    <meta property="og:title" content=""/>
    <meta property="og:url" content="http://blog.popowa.com/2011/07/sys-syslog-remote-logging-client.html"/>
    <meta property="og:site_name" content="popowa"/>
    <meta property="og:type" content="article"/>

    <link rel="canonical" href="http://blog.popowa.com/2011/07/sys-syslog-remote-logging-client.html" />

    <title> | popowa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" />
    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" />

    <link rel="stylesheet" type="text/css" href="http://blog.popowa.com/theme/css/main.css" />

    <script type="text/javascript">var switchTo5x=true;</script>
    <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
    <script type="text/javascript">
        stLight.options({
            publisher: "",
            doNotHash: false,
            doNotCopy: false,
            hashAddressBar: false
        });
    </script>
</head>

<body id="index">
    <div class="row-fluid">
        <div class="span10 offset1">
            <header id="banner" >
                <h1>
                    <a href="http://blog.popowa.com/">popowa </a>
                </h1>
                <nav class="navbar">
                    <div class="navbar-inner">
                        <ul class="nav">
                            <li class="active"><a href="http://blog.popowa.com/category/misc.html">misc</a></li>
                            <li ><a href="http://blog.popowa.com/category/tech.html">tech</a></li>
                        </ul>

                    </div>
                </nav>
            </header><!-- /#banner -->
        </div>
    </div>

    <div class="row-fluid">
        <div class="span10 offset1">
            <div class="row-fluid">
<div class="span10 offset1">
  <section>
    <article>
      <header>
        <h1 class="entry-title">
          <a href="http://blog.popowa.com/2011/07/sys-syslog-remote-logging-client.html" rel="bookmark"
             title="Permalink to "></a></h1>
      </header>
      <div class="entry-content">
<footer class="post-info">
    <address class="vcard author">
        by <a class="url fn" href="http://blog.popowa.com/author/ayakomuro.html">ayakomuro</a>
    </address>

    in <a href="http://blog.popowa.com/category/misc.html">misc</a>

    on 2011-07-31

        |
        tags:         <a href="http://blog.popowa.com/tag/rightscript.html">RightScript</a>



    
</footer><!-- /.post-info -->

        <p>client+個別のライトスクリプトを日本語化してみます：SYS Syslog remote
logging client<br>
[]<br>
<strong>SYS Syslog remote logging client</strong>  </p>
<blockquote>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash -ex</span>
<span class="c1"># Copyright (c) 2007-2011 by RightScale Inc., all rights reserved</span>
<span class="nb">set</span> +e
<span class="c1">#シェルオプション設定コマンドsetでコマンドが0以外のステータスで終了した場合，</span>
<span class="c1">#一部の場合を除いて即座に終了しないようにする</span>
which rs_tag
<span class="c1">#</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="c1">#rs_tagのパスの値（$?)が0ではなかった場合、</span>
  <span class="nb">echo</span> -e <span class="s2">&quot;FATAL ERROR: this RightScript only supports v5 based</span>
<span class="s2">　RightImages that have rs_tag support!</span>
<span class="s2">　You must use SYS Syslog Remote Logging Client v7 instead if you are using a v4 RightImage&quot;</span>
 <span class="c1">#ライトスクリプトはrs_tagに対応しているv5ベースのライトイメージに対応している </span>
 <span class="c1">#v4のライトイメージだった場合は、SYS Syslog Remote Logging client v7を使う必要がある</span>
<span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>
<span class="nb">set</span> -e
<span class="c1"># Auto-gernerate config file</span>
<span class="k">function</span> write_config
<span class="c1">#write_config関数を作成する</span>
<span class="o">{</span>
  <span class="o">[</span> -e /etc/syslog-ng/syslog-ng.conf <span class="o">]</span> <span class="o">&amp;&amp;</span> mv -f /etc/syslog-ng/syslog-ng.conf /etc/syslog-ng/syslog-ng.conf.bak.<span class="k">$(</span>date <span class="s2">&quot;+%Y%m%d%H%M%S&quot;</span><span class="k">)</span>
　<span class="c1">#syslog-ng.confがあって、そのファイルを日時付きでバックアップ出来たら</span>
  cp <span class="nv">$RS_ATTACH_DIR</span>/syslog-ng-remote.conf /etc/syslog-ng/syslog-ng.conf
  <span class="c1">#RS_ATTACH_DIRに添付されているsyslog-ng-remote.confからコピーする</span>
  <span class="c1">#Inject Instance ID into config</span>
  perl -p -i -e <span class="s1">&#39;s/i-123456/&#39;</span><span class="nv">$SERVER_UUID</span><span class="s1">&#39;/&#39;</span> /etc/syslog-ng/syslog-ng.conf
　<span class="c1">#InstanceのIDをコンフィグ内に書き込む</span>
  <span class="c1">#set syslog server.</span>
  perl -p -i -e <span class="s1">&#39;s/syslog.rightscale.com/&#39;</span><span class="nv">$SYSLOG_SERVER</span><span class="s1">&#39;/&#39;</span> /etc/syslog-ng/syslog-ng.conf
  <span class="c1"># Set apache log dir (for haproxy.log)</span>
  sed -i <span class="s2">&quot;/@@APACHE_LOG_DIR@@/s//</span><span class="nv">$apache_log_dir</span><span class="s2">/&quot;</span> /etc/syslog-ng/syslog-ng.conf
<span class="o">}</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$RS_DISTRO</span><span class="s2">&quot;</span> <span class="o">=</span> ubuntu <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="c1">#ディストリビューションがUbuntuだったら</span>
  <span class="nv">logrotate_file</span><span class="o">=</span>/etc/logrotate.d/syslog-ng
  <span class="nv">apache_log_dir</span><span class="o">=</span>apache2
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$RS_DISTRO</span><span class="s2">&quot;</span> <span class="o">=</span> centos <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="c1">#ディストリビューションがCenntosだったら</span>
  <span class="nv">logrotate_file</span><span class="o">=</span>/etc/logrotate.d/syslog
  <span class="nv">apache_log_dir</span><span class="o">=</span>httpd
<span class="k">fi</span>

<span class="c1"># Test if this script has already run.  If so it is either a boot script being re-run</span>
<span class="c1"># or the server is being started from a stopped state.  Update the config - same as reboot.</span>
<span class="k">if</span> <span class="nb">test</span> <span class="s2">&quot;</span><span class="nv">$RS_REBOOT</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span> -o <span class="s2">&quot;</span><span class="nv">$RS_ALREADY_RUN</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span><span class="p">;</span> <span class="k">then</span>
<span class="c1">#もしリブート処理だったり、すでに起動済みだった場合</span>
  <span class="nb">echo</span> <span class="s2">&quot;Update SYSLOG configuration on REBOOT.&quot;</span>
  write_config
  <span class="c1">#先ほどの関数を走らせて、アップデートを行う</span>
  service syslog-ng restart
  <span class="c1">#syslogn-ngをリスタートさせる</span>
  <span class="c1"># Tag instance for start/stop support</span>
  rs_tag -a <span class="s2">&quot;rs_logging:state=active&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;Setting logging active tag&quot;</span>
　<span class="c1">#rs_tagで設定する（rs_tag説明部分を参照）</span>
  logger -t RightScale <span class="s2">&quot;Updated SYSLOG configuration on REBOOT.&quot;</span>
　<span class="c1">#logに記録</span>
  <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$RS_DISTRO</span><span class="s2">&quot;</span> <span class="o">=</span> ubuntu <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  apt-get install -y syslog-ng <span class="c1">#必要パッケージをインストール</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="k">$(</span>lsb_release -rs<span class="k">)</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;8.04&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
　<span class="c1">#lsb_releaseコマンドを使って現在のバージョンを確認。8.04だったら</span>
    <span class="nb">export</span> <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span><span class="s2">&quot;noninteractive&quot;</span><span class="p">;</span> apt-get install  -y sysvconfig
　　<span class="c1">#syslong-ngだけではなくsysvconfigもインストール</span>
  <span class="k">fi</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$RS_DISTRO</span><span class="s2">&quot;</span> <span class="o">=</span> centos <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  yum install -y syslog-ng
<span class="k">fi</span>

<span class="c1">#create a new /dev/null for syslog-ng to use</span>
<span class="c1">#</span>
<span class="k">if</span> <span class="o">[</span> ! -e /dev/null.syslog-ng <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="c1">#もしスペシャルファイル作成されていなかったらmknodで作成する</span>
  mknod /dev/null.syslog-ng c <span class="m">1</span> <span class="m">3</span>
<span class="k">fi</span>

write_config <span class="c1">#先ほどの関数を走らせる</span>
<span class="c1"># Ensure everything in /var/log is owned by root, not syslog.</span>
chown root /var/log/* <span class="c1">#ファイル/ディレクトリの所有者を変更する</span>
service syslog-ng restart <span class="c1">#syslog-ngを再起動</span>

<span class="c1"># Set up log file rotation #ログローテイトの設定</span>
perl -p -i -e <span class="s1">&#39;s/weekly/daily/; s/rotates+d+/rotate 7/&#39;</span> /etc/logrotate.conf

<span class="c1"># fix /var/log/boot.log issue #ブートログのバグを対応する</span>
<span class="o">[</span> ! -e /var/log/boot.log <span class="o">]</span> <span class="o">&amp;&amp;</span> touch /var/log/boot.log

<span class="o">[</span> -z <span class="s2">&quot;</span><span class="k">$(</span>grep -lir <span class="s2">&quot;missingok&quot;</span> <span class="nv">$logrotate_file</span><span class="k">)</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> sed -i <span class="s1">&#39;/sharedscripts/ a    missingok&#39;</span> <span class="nv">$logrotate_file</span>
<span class="c1">#logrotate_fileからmissingokを検索して、文字数が0だったら、logrotate_fileに&#39;sharedscripts&#39;の後に&#39;missingok&#39;を追加する</span>
<span class="o">[</span> -z <span class="s2">&quot;</span><span class="k">$(</span>grep -lir <span class="s2">&quot;notifempty&quot;</span> <span class="nv">$logrotate_file</span><span class="k">)</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> sed -i <span class="s1">&#39;/sharedscripts/ a    notifempty&#39;</span> <span class="nv">$logrotate_file</span>

<span class="c1"># add mail to logrotate</span>
mkdir -p /var/spool/oldmail
chmod <span class="m">775</span> /var/spool/oldmail
chown root:mail /var/spool/oldmail

cat <span class="s">&lt;&lt;EOF&gt; /etc/logrotate.d/mail</span>
<span class="s">/var/spool/mail/* {</span>
<span class="s">   daily</span>
<span class="s">   compress</span>
<span class="s">   notifempty</span>
<span class="s">   missingok</span>
<span class="s">   olddir /var/spool/oldmail</span>
<span class="s">}</span>
<span class="s">#/etc/logrotate.d/mailを上書きする</span>
<span class="s">EOF</span>

<span class="c1"># tag required for RightLink enabled images</span>
rs_tag -a <span class="s2">&quot;rs_logging:state=active&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;Setting logging active tag&quot;</span>
<span class="c1">#rs_tagを使ってタグを追加する</span>
</pre></div>
</td></tr></table>

</blockquote>

      </div><!-- /.entry-content -->

    </article>
  </section>
</div>
            </div>
        </div>
    </div>

    <footer id="site-footer">
        <div class="row-fluid">
            <div class="span10 offset1">
                <address>
                    <p>
                        This blog is proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                    </p>
                    <p>
                        <a href="http://github.com/jsliang/pelican-fresh/">Fresh</a> is a responsive theme designed by <a href="http://jsliang.com/">jsliang</a> and <a href="https://github.com/jsliang/pelican-fresh/graphs/contributors">contributors</a>.
                        Special thanks to <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a> and <a href="http://getbootstrap.com/">Twitter Bootstrap</a>.
                    </p>
                </address>
            </div>
        </div>
    </footer>

    <script src="//code.jquery.com/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>
</body>
</html>